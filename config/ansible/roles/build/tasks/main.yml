---

- name: Create config files from template
  template:
    src: '{{ item }}.j2'
    dest: '{{ workspace }}/{{ item }}'
    mode: 0755
  with_items:
    - entrypoint.sh
    - Dockerfile
    - php.ini

- name: Install project dependencies with composer
  shell: '{{ php_bin }} {{ composer_bin }} install'
  args:
    chdir: '{{ workspace }}'

- name: Pull base image to get latest version
  docker_image:
    name: '{{ base_image }}'
    source: pull

- name: Build an image and push it to a private repo
  docker_image:
    build:
      path: '{{ workspace }}'
    force: yes
    name: '{{ image_name }}'
    tag: 'latest'
    push: yes
    source: build

- name: Tag and push to local registry
  docker_image:
    name: '{{ image_name }}:latest'
    repository: '{{ image_name }}:build-{{ version }}'
    force_tag: yes
    push: yes
    source: local
